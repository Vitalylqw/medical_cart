# Карта проекта "Nataly" (Telegram Audio Transcriber)

## 1. Краткое описание
Проект представляет собой Telegram-бота для транскрипции аудиосообщений и файлов. Использует локальные модели (Faster Whisper, CTranslate2) и внешние сервисы (опционально). Основной упор на работу в среде Windows с использованием GPU (CUDA).

## 2. Цели и Задачи
- **Цель:** Обеспечить качественную и бесплатную транскрипцию аудио для личного использования/группы пользователей.
- **Задачи:** Прием аудио/войсов из TG, конвертация, транскрипция с таймкодами, отправка результата обратно.

## 3. Архитектура и Структура (`src/`)

### Точка входа
- `src/app.py`: Основной файл запуска. Инициализирует бота, базу данных и сервисы. Использует `DefaultBotProperties` для настройки бота.

### Основные модули
- **`src/bot/`**: Логика взаимодействия с Telegram (aiogram 3.x).
  - `router.py`: Обработчики команд (/start, /help, /settings) и медиа-файлов.
- **`src/transcription/`**: Ядро распознавания речи.
  - `router.py`: Маршрутизация задач транскрипции (Local -> Cloud fallback).
  - `audio_io.py`: Работа с аудиофайлами (загрузка, конвертация ffmpeg в 16k mono WAV).
  - `chunking.py`: Разбиение длинных аудио на сегменты.
  - `providers/`: Реализации движков.
    - `faster_whisper.py`: Локальный движок (GPU/CPU), загрузка моделей из `var/models`.
    - `openai_whisper.py`: Облачный резерв.
- **`src/core/`**: Системные компоненты.
  - `config.py`: Загрузка настроек (`settings.yaml` + `.env`).
  - `storage.py`: Работа с SQLite (хранение хэшей транскриптов).
  - `logging.py`: Настройка логирования (цветной вывод).
- **`src/domain/`**: Бизнес-логика и модели данных (Pydantic).
- **`src/utils/`**: Вспомогательные функции (хэширование SHA-256, i18n).

## 4. Ориентация по папкам
- **`var/`**: Изменяемые данные (в `.gitignore` кроме структуры).
  - `app.db`: База данных SQLite.
  - `models/`: Веса нейросетей (faster-whisper-large-v3).
  - `cache/`: Временные файлы обработки и кэш аудио.
- **`scripts/`**: Скрипты обслуживания и тестов.
  - `debug/`: Скрипты для отладки проблем (`check_model_cache.py`).
  - `test/`: Тесты (`benchmark_cuda.py`, `check_cuda.py`, `check_db.py`).
  - `servises/`: Служебные скрипты (`download_faster_whisper_model`, `recreate_venv`, `test_cuda`).

## 5. Принципы разработки
- **ОС:** Windows 10 (учет путей, кодировок, `.bat` файлов).
- **Стек:** Python 3.11, aiogram 3.22+, faster-whisper 1.0.3, SQLAlchemy.
- **Правила:**
  - Скрипты хранить строго в `scripts/{debug,test,servises}`.
  - Не менять работающий код без явной необходимости.
  - Документировать изменения.
  - Использовать `.bat` файлы для запуска в venv на Windows.

## 6. Текущие важные заметки
- Для работы с `venv` на Windows использовать `.bat` файлы.
- `numpy==1.26.4` критичен для работы ctranslate2 на Windows.
- Модели загружаются строго локально (`local_files_only=True`) из `var/models/`.
- При возникновении ошибок DLL/CUDA запускать `scripts/servises/test_cuda.py`.
